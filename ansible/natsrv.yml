---
- name: Setup NatSrv
  hosts: all
  become: yes
  tasks:
    - name: install iptables
      apt:
        name: iptables
        state: present
        update_cache: yes
    
    - name: install iptables-persistent
      apt:
        name: iptables-persistent
        state: present
        update_cache: yes

    - name: Create users
      user:
        name: "{{ item }}"
        state: present
        shell: "/bin/bash"
      with_items:
        - devs

    - name: Add SSH key
      ansible.posix.authorized_key:
        user: devs
        state: present
        key: "{{ item }}"
      loop: "{{ ssh_keys }}"

    - name: Enable IPv4 forwarding
      lineinfile:
        path: /etc/sysctl.conf
        line: "net.ipv4.ip_forward=1"
        create: yes

    - name: Apply sysctl changes
      command: sysctl -p

    - name: Configure NAT with iptables
      command: iptables -t nat -A POSTROUTING -o $(ip -o -4 route show to default | awk '{print $5}') -j MASQUERADE
      args:
        executable: /bin/bash
  
    - name: Save iptables rules
      command: iptables-save > /etc/iptables/rules.v4
      args:
        executable: /bin/bash